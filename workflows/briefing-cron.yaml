# Finance Briefing Workflow for Cron (No Approval Gate)
# Usage: lobster run --file workflows/briefing-cron.yaml --args-json '{"lang":"de"}'
#
# This workflow:
# 1. Generates a market briefing via local .venv CLI
# 2. Translates portfolio headlines (German)
# 3. Validates output and exits (no delivery)

name: vfinance.briefing.cron
description: Generate market briefing for cron (no delivery)

args:
  lang:
    default: de
    description: "Language: en or de"
  fast:
    default: "false"
    description: "Use fast mode: true or false"

steps:
  # Generate briefing and save to temp file
  - id: generate
    command: |
      SKILL_DIR="${SKILL_DIR:-$HOME/projects/skills/personal/vfinance-news}"
      FAST_FLAG=""
      if [ "${fast}" = "true" ]; then FAST_FLAG="--fast"; fi
      OUTFILE="/tmp/lobster-briefing-$$.json"
      VFINANCE_NEWS_BIN="${VFINANCE_NEWS_BIN:-$SKILL_DIR/.venv/bin/vfinance-news}"
      if [ ! -x "$VFINANCE_NEWS_BIN" ]; then
        echo "❌ Missing CLI at $VFINANCE_NEWS_BIN. Install with: python3 -m venv $SKILL_DIR/.venv && $SKILL_DIR/.venv/bin/pip install -e $SKILL_DIR"
        exit 1
      fi
      "$VFINANCE_NEWS_BIN" briefing \
        --style briefing \
        --lang "${lang}" \
        --json \
        $FAST_FLAG > "$OUTFILE"
      # Output the file path for subsequent steps
      echo "$OUTFILE"
    description: Generate briefing via local .venv CLI

  # Translate portfolio headlines (if German)
  - id: translate
    command: |
      OUTFILE=$(cat)
      OUTFILE=$(echo "$OUTFILE" | tr -d '\n')
      SKILL_DIR="${SKILL_DIR:-$HOME/projects/skills/personal/vfinance-news}"
      if [ "${lang}" = "de" ]; then
        "$SKILL_DIR/.venv/bin/python" -m vfinance_news.translate_portfolio "$OUTFILE" --lang de || true
      fi
      echo "$OUTFILE"
    stdin: $generate.stdout
    description: Translate portfolio headlines via openclaw

  # Validate deterministic structured macro output
  - id: validate
    command: |
      OUTFILE=$(cat)
      OUTFILE=$(echo "$OUTFILE" | tr -d '\n')
      MODE=$(jq -r '.summary_mode // "unknown"' "$OUTFILE")
      STRUCT_OK=$(jq -r '.summary_structure_ok // false' "$OUTFILE")

      if [ "$MODE" != "deterministic" ] || [ "$STRUCT_OK" != "true" ]; then
        echo "❌ Refusing malformed macro briefing output"
        jq '{summary_mode, summary_model_used, summary_structure_ok, summary_missing_sections, generator}' "$OUTFILE"
        exit 1
      fi

      echo "$OUTFILE"
    stdin: $translate.stdout
    description: Validate deterministic structured output

  # Output validated briefing path for downstream cron handling
  - id: complete
    command: |
      OUTFILE=$(cat)
      OUTFILE=$(echo "$OUTFILE" | tr -d '\n')
      echo "Validated briefing: $OUTFILE"
    stdin: $validate.stdout
    description: Finish workflow without delivery
