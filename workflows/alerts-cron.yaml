# Price Alerts Workflow for Cron (No Approval Gate)
# Usage: lobster run --file workflows/alerts-cron.yaml --args-json '{"lang":"en"}'
#
# Schedule: 2:00 PM PT / 5:00 PM ET (1 hour after market close)
# Checks price alerts against current prices (including after-hours)

name: vfinance.alerts.cron
description: Check price alerts and print triggered alerts

args:
  lang:
    default: en
    description: "Language: en or de"

steps:
  # Check alerts against current prices
  - id: check_alerts
    command: |
      SKILL_DIR="${SKILL_DIR:-$HOME/projects/skills/personal/vfinance-news}"
      "$SKILL_DIR/.venv/bin/python" -m vfinance_news.alerts check --lang "${lang}"
    description: Check price alerts against current prices

  # Print alert message summary if there's content
  - id: summarize_alerts
    command: |
      MSG=$(cat)
      MSG=$(echo "$MSG" | tr -d '\r')
      # Only print if message has actual content (not just "No price data" message)
      if echo "$MSG" | grep -q "IN BUY ZONE\|IN KAUFZONE\|WATCHING\|BEOBACHTUNG"; then
        echo "$MSG"
      else
        echo "No triggered alerts or watchlist items"
      fi
    stdin: $check_alerts.stdout
    description: Print price alerts
