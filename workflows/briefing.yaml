# Finance Briefing Workflow for Lobster
# Usage: lobster "workflows.run --file workflows/briefing.yaml --args-json '{\"fast\":\"false\"}'"
#
# This workflow:
# 1. Generates a market briefing via local .venv CLI
# 2. Halts for approval before completion
# 3. Ends after approval review

name: vfinance.briefing
description: Generate market briefing with approval gate

args:
  fast:
    default: "false"
    description: "Use fast mode: true or false"

steps:
  # Generate briefing and save to temp file
  - id: generate
    command: |
      SKILL_DIR="${SKILL_DIR:-$HOME/projects/skills/personal/vfinance-news}"
      FAST_FLAG=""
      if [ "${fast}" = "true" ]; then FAST_FLAG="--fast"; fi
      OUTFILE="/tmp/lobster-briefing-$$.json"
      VFINANCE_NEWS_BIN="${VFINANCE_NEWS_BIN:-$SKILL_DIR/.venv/bin/vfinance-news}"
      if [ ! -x "$VFINANCE_NEWS_BIN" ]; then
        echo "❌ Missing CLI at $VFINANCE_NEWS_BIN. Install with: python3 -m venv $SKILL_DIR/.venv && $SKILL_DIR/.venv/bin/pip install -e $SKILL_DIR"
        exit 1
      fi
      "$VFINANCE_NEWS_BIN" briefing \
        --style briefing \
        --json \
        $FAST_FLAG > "$OUTFILE"
      # Output the file path for subsequent steps
      echo "$OUTFILE"
    description: Generate briefing via local .venv CLI

  # Validate deterministic structured macro output before approval
  - id: validate
    command: |
      OUTFILE=$(cat)
      OUTFILE=$(echo "$OUTFILE" | tr -d '\n')
      MODE=$(jq -r '.summary_mode // "unknown"' "$OUTFILE")
      STRUCT_OK=$(jq -r '.summary_structure_ok // false' "$OUTFILE")

      if [ "$MODE" != "deterministic" ] || [ "$STRUCT_OK" != "true" ]; then
        echo "❌ Refusing malformed macro briefing output"
        jq '{summary_mode, summary_model_used, summary_structure_ok, summary_missing_sections, generator}' "$OUTFILE"
        exit 1
      fi

      echo "$OUTFILE"
    stdin: $generate.stdout
    description: Validate deterministic structured output

  # Approval gate - workflow halts here until user approves
  - id: approve
    approval: required
    command: |
      OUTFILE=$(cat)
      echo "Briefing saved to: $OUTFILE"
      cat "$OUTFILE" | jq -r '.macro_message' | head -20
      echo "..."
      echo "Review above."
    stdin: $validate.stdout
    description: Approval gate before completion
